<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GrillBot</title>
  </head>
  <body>
    <canvas id="graph"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
      const chart = new Chart(document.getElementById('graph'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Temperature 1',
              data: []
            },
            {
              label: 'Temperature 2',
              data: []
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Temperatures'
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                  unit: 'hour'
              }
            }
          }
        },
      })

      const pushReading = reading => {
        chart.data.labels.push(new Date(Date.parse(reading.received)))
        chart.data.datasets[0].data.push(reading.temp1)
        chart.data.datasets[1].data.push(reading.temp2)
      }
      
      const initialFetch = async () => {
        const res = await fetch('/api/readings')
        const json = await res.json()
        json.items.forEach(reading => pushReading(reading))
        chart.update()
      }

      const startStream = async () => {
        const socket = new WebSocket(`ws://${window.location.host}/api/readings/stream`);
        socket.onmessage = event => {
          const reading = JSON.parse(event.data)
          pushReading(reading)
          chart.update()
        }
      }

      initialFetch()
        .then(() => startStream())
        .catch(e => console.log(error))
    </script>
  </body>
</html>
